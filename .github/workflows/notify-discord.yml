name: Notify Discord on Repository Events

on:
  issues:
    types: [opened]
  pull_request:
    types: [closed]
  issue_comment:
    types: [created]
  create:
    types: [branch]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Notify Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          EVENT_NAME=${{ github.event_name }}
          ACTOR=${{ github.actor }}
          REPO=${{ github.repository }}
          REF=${{ github.ref }}
          EVENT_PATH="$GITHUB_EVENT_PATH"

          MESSAGE="GitHub Event: \`${EVENT_NAME}\` in \`${REPO}\` by \`${ACTOR}\`. Ref: \`${REF}\`"

          if [ "$EVENT_NAME" = "pull_request" ]; then
            ACTION=$(jq -r '.action' "$EVENT_PATH")
            TITLE=$(jq -r '.pull_request.title // "No title"' "$EVENT_PATH")
            URL=$(jq -r '.pull_request.html_url // "No URL"' "$EVENT_PATH")
            NUMBER=$(jq -r '.pull_request.number // "unknown"' "$EVENT_PATH")
            BASE_BRANCH=$(jq -r '.pull_request.base.ref // "unknown"' "$EVENT_PATH")
            if [ "$ACTION" = "closed" ] && [ "$BASE_BRANCH" = "main" ]; then
              MESSAGE="[${REPO}] Pull request closed: #${NUMBER} ${TITLE}\nðŸ”— $URL"
            fi
          fi

          if [ "$EVENT_NAME" = "issues" ]; then
            ACTION=$(jq -r '.action' "$EVENT_PATH")
            TITLE=$(jq -r '.issue.title // "No title"' "$EVENT_PATH")
            NUMBER=$(jq -r '.issue.number // "unknown"' "$EVENT_PATH")
            URL=$(jq -r '.issue.html_url // "No URL"' "$EVENT_PATH")
            if [ "$ACTION" = "opened" ]; then
              MESSAGE="[${REPO}] New issue #${NUMBER}: ${TITLE}\nðŸ”— $URL"
            fi
          fi

          if [ "$EVENT_NAME" = "issue_comment" ]; then
            ACTION=$(jq -r '.action' "$EVENT_PATH")
            COMMENT=$(jq -r '.comment.body // "No comment"' "$EVENT_PATH")
            URL=$(jq -r '.comment.html_url // "No URL"' "$EVENT_PATH")
            PR_NUMBER=$(jq -r '.issue.pull_request.url // ""' "$EVENT_PATH" | awk -F'/' '{print $NF}')
            if [ "$ACTION" = "created" ] && [ -n "$PR_NUMBER" ]; then
              MESSAGE="[${REPO}] New comment on pull request #${PR_NUMBER}: ${COMMENT}\nðŸ”— $URL"
            fi
          fi

          if [ "$EVENT_NAME" = "create" ]; then
            TYPE=$(jq -r '.ref_type // "unknown"' "$EVENT_PATH")
            NAME=$(jq -r '.ref // "unknown"' "$EVENT_PATH")
            if [ "$TYPE" = "branch" ]; then
              MESSAGE="[${REPO}] New branch created: ${NAME}"
            fi
          fi

          echo "Sending to Discord:"
          echo "$MESSAGE"

          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{\"content\": \"$MESSAGE\"}" \
               "$DISCORD_WEBHOOK"
