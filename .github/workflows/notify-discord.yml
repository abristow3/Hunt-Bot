name: Notify Discord on Repository Events

on:
  push:
  pull_request:
  issues:
  release:
  issue_comment:
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Event to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          echo "ðŸ”§ Preparing GitHub event data"

          EVENT_NAME="${{ github.event_name }}"
          ACTOR="${{ github.actor }}"
          REPO="${{ github.repository }}"
          REF="${{ github.ref }}"
          SERVER_URL="https://github.com/${REPO}"

          MESSAGE="ðŸ“£ Unknown event: $EVENT_NAME by $ACTOR on $REPO"

          case "$EVENT_NAME" in
            push)
              BRANCH=$(echo "$REF" | sed 's|refs/heads/||')
              COMMITS=$(jq -r '.commits[].message' "$GITHUB_EVENT_PATH" | paste -sd '; ' -)
              COMMIT_URL=$(jq -r '.compare' "$GITHUB_EVENT_PATH")
              MESSAGE="ðŸš€ **${ACTOR}** pushed to **${BRANCH}** in [${REPO}](${SERVER_URL})
        [ View changes ](${COMMIT_URL})
        **Messages:** ${COMMITS:-_No commit messages_}"
        ;;
        
        pull_request)
        ACTION=$(jq -r '.action' "$GITHUB_EVENT_PATH")
        PR_TITLE=$(jq -r '.pull_request.title' "$GITHUB_EVENT_PATH")
        PR_URL=$(jq -r '.pull_request.html_url' "$GITHUB_EVENT_PATH")
        BRANCH=$(jq -r '.pull_request.head.ref' "$GITHUB_EVENT_PATH")
        MESSAGE="ðŸ“¬ **${ACTOR}** ${ACTION} a pull request in [${REPO}](${SERVER_URL})
        ðŸ”€ **${PR_TITLE}** â†’ **${BRANCH}**
        [View Pull Request](${PR_URL})"
        ;;
        
        issues)
        ACTION=$(jq -r '.action' "$GITHUB_EVENT_PATH")
        ISSUE_TITLE=$(jq -r '.issue.title' "$GITHUB_EVENT_PATH")
        ISSUE_URL=$(jq -r '.issue.html_url' "$GITHUB_EVENT_PATH")
        MESSAGE="ðŸ› **${ACTOR}** ${ACTION} an issue in [${REPO}](${SERVER_URL})
        ðŸ“ **${ISSUE_TITLE}**
        [View Issue](${ISSUE_URL})"
        ;;
        
        release)
        ACTION=$(jq -r '.action' "$GITHUB_EVENT_PATH")
        RELEASE_NAME=$(jq -r '.release.name' "$GITHUB_EVENT_PATH")
        RELEASE_URL=$(jq -r '.release.html_url' "$GITHUB_EVENT_PATH")
        MESSAGE="ðŸ“¦ **${ACTOR}** ${ACTION} a release in [${REPO}](${SERVER_URL})
        ðŸ·ï¸ **${RELEASE_NAME}**
        [View Release](${RELEASE_URL})"
        ;;
        esac
        
        echo "Sending to Discord: $MESSAGE"
        
        echo '{}' | jq --arg msg "$MESSAGE" '{content: $msg}' > payload.json
        
        curl -s -H "Content-Type: application/json" \
          -X POST \
          -d @payload.json \
          "$DISCORD_WEBHOOK"
        

