name: Notify Discord on Repository Events

on:
  issues:
    types: [opened]
  pull_request:
    types: [closed]
  issue_comment:
    types: [created]
  create: # temporarily catch all create events for debugging

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Notify Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          EVENT_NAME=${{ github.event_name }}
          ACTOR=${{ github.actor }}
          REPO=${{ github.repository }}
          REF=${{ github.ref }}
          EVENT_PATH="$GITHUB_EVENT_PATH"
          ACTOR_AVATAR=$(jq -r '.sender.avatar_url // ""' "$EVENT_PATH")

          EMBED_TITLE=""
          EMBED_DESCRIPTION=""
          EMBED_URL=""
          EMBED_COLOR=0 # default color

          # Pull request closed into main
          if [ "$EVENT_NAME" = "pull_request" ]; then
            ACTION=$(jq -r '.action' "$EVENT_PATH")
            TITLE=$(jq -r '.pull_request.title // "No title"' "$EVENT_PATH")
            URL=$(jq -r '.pull_request.html_url // "No URL"' "$EVENT_PATH")
            NUMBER=$(jq -r '.pull_request.number // "unknown"' "$EVENT_PATH")
            BASE_BRANCH=$(jq -r '.pull_request.base.ref // "unknown"' "$EVENT_PATH")
            BODY=$(jq -r '.pull_request.body // ""' "$EVENT_PATH")
            if [ "$ACTION" = "closed" ] && [ "$BASE_BRANCH" = "main" ]; then
              EMBED_TITLE="[${REPO}] Pull request closed: #${NUMBER} ${TITLE}"
              EMBED_DESCRIPTION="$BODY"
              EMBED_URL="$URL"
              EMBED_COLOR=65280       # green for merges
            fi
          fi

          # New issue opened
          if [ "$EVENT_NAME" = "issues" ]; then
            ACTION=$(jq -r '.action' "$EVENT_PATH")
            TITLE=$(jq -r '.issue.title // "No title"' "$EVENT_PATH")
            NUMBER=$(jq -r '.issue.number // "unknown"' "$EVENT_PATH")
            URL=$(jq -r '.issue.html_url // "No URL"' "$EVENT_PATH")
            BODY=$(jq -r '.issue.body // ""' "$EVENT_PATH")
            if [ "$ACTION" = "opened" ]; then
              EMBED_TITLE="[${REPO}] New issue #${NUMBER}: ${TITLE}"
              EMBED_DESCRIPTION="$BODY"
              EMBED_URL="$URL"
              EMBED_COLOR=3329330      # soft green for new issues
            fi
          fi

          # Comments on issues or PRs
          if [ "$EVENT_NAME" = "issue_comment" ]; then
            ACTION=$(jq -r '.action' "$EVENT_PATH")
            COMMENT=$(jq -r '.comment.body // "No comment"' "$EVENT_PATH")
            URL=$(jq -r '.comment.html_url // "No URL"' "$EVENT_PATH")
            ISSUE_NUMBER=$(jq -r '.issue.number // "unknown"' "$EVENT_PATH")
            ISSUE_TITLE=$(jq -r '.issue.title // "No title"' "$EVENT_PATH")
            PR_URL=$(jq -r '.issue.pull_request.url // ""' "$EVENT_PATH")

            if [ "$ACTION" = "created" ]; then
              if [ -n "$PR_URL" ]; then
                EMBED_TITLE="[${REPO}] New comment on pull request #${ISSUE_NUMBER}: ${ISSUE_TITLE}"
              else
                EMBED_TITLE="[${REPO}] New comment on issue #${ISSUE_NUMBER}: ${ISSUE_TITLE}"
              fi
              EMBED_DESCRIPTION="$COMMENT"
              EMBED_URL="$URL"
              EMBED_COLOR=16766720      # softer gold for comments
            fi
          fi

          # New branch created
          if [ "$EVENT_NAME" = "create" ]; then
            echo "DEBUG: Create event JSON:"
            cat "$EVENT_PATH"  # Log full create event JSON

            TYPE=$(jq -r '.ref_type // "unknown"' "$EVENT_PATH")
            NAME=$(jq -r '.ref // "unknown"' "$EVENT_PATH")
            echo "DEBUG: type=$TYPE, name=$NAME"

            if [ "$TYPE" = "branch" ]; then
              EMBED_TITLE="[${REPO}] New branch created: ${NAME}"
              EMBED_DESCRIPTION=""
              EMBED_URL=""
              EMBED_COLOR=3329330      # soft green for new branches
            fi
          fi

          echo "Sending to Discord:"
          echo "Title: $EMBED_TITLE"
          echo "Description: $EMBED_DESCRIPTION"
          echo "URL: $EMBED_URL"
          echo "Author: $ACTOR, Avatar: $ACTOR_AVATAR"
          echo "Color: $EMBED_COLOR"

          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{
                 \"embeds\": [{
                   \"author\": {
                     \"name\": \"$ACTOR\",
                     \"icon_url\": \"$ACTOR_AVATAR\"
                   },
                   \"title\": \"$EMBED_TITLE\",
                   \"description\": \"$EMBED_DESCRIPTION\",
                   \"url\": \"$EMBED_URL\",
                   \"color\": $EMBED_COLOR
                 }]
               }" \
               "$DISCORD_WEBHOOK"
